<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="bits of blogging"><meta name="generator" content="Eleventy"><link rel="icon" href="/favicon.ico"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><title>Debug logging in Go</title><link rel="stylesheet" href="/site.css"><link rel="stylesheet" href="/prism-one-dark.css"></head><body class="flex flex-col min-h-screen mx-6 md:mx-auto my-auto max-w-2xl"><main class="flex-grow pt-6 md:pt-12"><div class="flex flex-col md-960:flex-row"><div class="mb-4 md-960:-ml-32 md-960:mr-8"><a href="https://twiddlingbits.net/"><img src="https://www.gravatar.com/avatar/6dd0c8e5214e4c4d0f0dafabebe82c3d?size=96"></a></div><div class="pt-4"><article class="space-y-24"><div class="flex flex-col gap-y-5"><h1 class="text-4xl font-bold">Debug logging in Go</h1><div class="flex gap-x-2 text-gray-400"><div class="flex gap-x-1">Last updated: <span class="italic">May 15, 2022</span></div>&bull;<div class="flex gap-x-1"><span>1 min </span>read</div></div></div><div class="prose"><p>My project, <a href="https://github.com/jcrd/lifelight">lifelight</a>, is written in Go and designed to run on low-powered <a href="https://www.raspberrypi.com/products/raspberry-pi-zero/">Raspberry Pis</a>. I wanted minimal overhead in the production build, so I implemented a logging system that is compiled out in non-debug builds. This is made easy using Go's <a href="https://pkg.go.dev/go/build#hdr-Build_Constraints"><em>build constraints</em></a>.</p><h2>The code</h2><p>This implementation utilizes three files: the main file, and two logger implementation files with build constraints.</p><p>The main file includes the interface definition and a global variable:</p><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main<br><br><span class="token keyword">type</span> Logger <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>    <span class="token comment">// format string, and objects to format</span><br>    <span class="token function">Log</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">var</span> logger Logger</code></pre><p>One of the logger implementations, the <em>dummy</em>, satisfies this interface with methods that do nothing:</p><pre class="language-go"><code class="language-go"><span class="token comment">//go:build !debug</span><br><br><span class="token keyword">package</span> main<br><br><span class="token keyword">type</span> DummyLogger <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>dl DummyLogger<span class="token punctuation">)</span> <span class="token function">log</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> v <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    logger <span class="token operator">=</span> DummyLogger<span class="token punctuation">{</span><span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>The <code>//go:build !debug</code> build constraint means that it will only be included in the production build when the <code>debug</code> tag is absent.</p><p>The <code>init</code> function will be called at runtime, setting the global <code>logger</code> variable for use in the rest of the program.</p><p>The debug logger is implemented in the same way, using the <code>//go:build debug</code> build constraint:</p><pre class="language-go"><code class="language-go"><span class="token comment">//go:build debug</span><br><br><span class="token keyword">package</span> main<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>	<span class="token string">"log"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">type</span> DebugLogger <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>dl <span class="token operator">*</span>DebugLogger<span class="token punctuation">)</span> <span class="token function">log</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> v <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> v<span class="token operator">...</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	logger <span class="token operator">=</span> <span class="token operator">&amp;</span>DebugLogger<span class="token punctuation">{</span><span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2>The build</h2><p>Specifying tags at build time is simple:</p><pre class="language-shell"><code class="language-shell">go build -tags debug <span class="token builtin class-name">.</span></code></pre><p>This can be integrated into a <code>Makefile</code>, for example:</p><pre class="language-shell"><code class="language-shell">main:<br>    go build <span class="token builtin class-name">.</span><br><br>debug:<br>    go build -tags debug <span class="token builtin class-name">.</span><br><br>.PHONY: debug</code></pre><p>Now, logging does nothing unless the <code>debug</code> tag is specified!</p></div></article></div></div></main><footer class="flex gap-x-1 py-10"><p class="text-gray-500">&nbsp;&copy; 2022</p><a class="hover:underline" href="https://twiddlingbits.net/">James Reed</a></footer></body></html>