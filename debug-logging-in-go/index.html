<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Debug logging in Go - twiddling bits</title><meta name=description content="bits of blogging"><meta name=generator content="Hugo 0.98.0"><link rel=stylesheet href="/css/main.min.ade3d6e80b0d4e4aa1a7146895c529788e69c9d38ff7c0b514cbc4c351a4a526.css"><script data-goatcounter=https://twiddlingbits.goatcounter.com/count async src=//gc.zgo.at/count.js></script></head><body class="flex flex-col h-screen mx-6 md:mx-auto my-auto max-w-2xl"><div class=py-6><nav class="flex flex-row justify-between text-lg"><div class="flex items-center gap-x-4"><a href=https://twiddlingbits.net><img src=https://twiddlingbits.net/images/icon.png width=24 height=24></a>
<a class="invisible sm:visible font-bold hover:underline" href=https://twiddlingbits.net>twiddling bits</a></div><ul class="flex flex-row gap-x-1 sm:gap-x-4"><li class="flex items-center gap-x-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg><a class="underline hover:no-underline" href=/about title>about</a></li><li class="flex items-center gap-x-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414.0l-7-7A.997.997.0 012 10V5a3 3 0 013-3h5c.256.0.512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg><a class="underline hover:no-underline" href=/tags/ title>tags</a></li></ul></nav></div><main class=flex-grow><article class="gap-y-2 post-border pt-6 md:pt-12"><h1 class="text-2xl font-bold">Debug logging in Go</h1><div class="flex flex-col gap-y-1 py-4 text-gray-500"><span class=italic>May 15, 2022</span><div class="flex flex-row gap-x-4"><div class="flex gap-x-1 italic"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-4" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3A9 9 0 113 12a9 9 0 0118 0z"/></svg>2 mins</div><div class="flex gap-x-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414.0l-7-7A.997.997.0 012 10V5a3 3 0 013-3h5c.256.0.512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg><ul class="flex flex-row flex-wrap gap-x-2"><li><a class=tag href=/tags/development>#development</a></li><li><a class=tag href=/tags/debugging>#debugging</a></li><li><a class=tag href=/tags/go>#go</a></li></ul></div></div></div><div class=prose><p>My project, <a href=https://github.com/jcrd/lifelight>lifelight</a>, is written in Go and designed to run on
low-powered <a href=https://www.raspberrypi.com/products/raspberry-pi-zero/>Raspberry Pis</a>. I wanted minimal overhead in the production
build, so I implemented a logging system that is compiled out in non-debug
builds. This is made easy using Go&rsquo;s <a href=https://pkg.go.dev/go/build#hdr-Build_Constraints><em>build constraints</em></a>.</p><h2 id=the-code>The code</h2><p>This implementation utilizes three files: the main file, and two logger
implementation files with build constraints.</p><p>The main file includes the interface definition and a global variable:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Logger</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// format string, and objects to format
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>Log</span><span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>logger</span> <span class=nx>Logger</span>
</span></span></code></pre></div><p>One of the logger implementations, the <em>dummy</em>, satisfies this interface with
methods that do nothing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//go:build !debug
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DummyLogger</span> <span class=kd>struct</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>dl</span> <span class=nx>DummyLogger</span><span class=p>)</span> <span class=nf>log</span><span class=p>(</span><span class=nx>format</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>v</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span> <span class=p>=</span> <span class=nx>DummyLogger</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>//go:build !debug</code> build constraint means that it will only be included in
the production build when the <code>debug</code> tag is absent.</p><p>The <code>init</code> function will be called at runtime, setting the global <code>logger</code>
variable for use in the rest of the program.</p><p>The debug logger is implemented in the same way, using the <code>//go:build debug</code>
build constraint:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//go:build debug
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>life</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DebugLogger</span> <span class=kd>struct</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>dl</span> <span class=o>*</span><span class=nx>DebugLogger</span><span class=p>)</span> <span class=nf>log</span><span class=p>(</span><span class=nx>format</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>v</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=nx>format</span><span class=p>,</span> <span class=nx>v</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>DebugLogger</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=the-build>The build</h2><p>Specifying tags at build time is simple:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>go build -tags debug .
</span></span></code></pre></div><p>This can be integrated into a <code>Makefile</code>, for example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Makefile data-lang=Makefile><span class=line><span class=cl><span class=nf>main</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    go build .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>debug</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    go build -tags debug .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>debug</span>
</span></span></code></pre></div><p>Now, logging does nothing unless the <code>debug</code> tag is specified!</p></div></article><div class="flex justify-center mt-2 text-gray-300 gap-x-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentcolor"><path d="M17.414 2.586a2 2 0 00-2.828.0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"/></svg><a class=hover:underline href=https://github.com/jcrd/jcrd.github.io/commit/fa787fb9a89a569dbdddffe46585db64858614fd>fa787fb</a></div></main><div class=py-10><footer class="flex flex-col gap-y-2"><div class="flex justify-center gap-x-1"><a class=hover:underline href=https://twiddlingbits.net/about>James Reed</a><p class=text-gray-500>&nbsp;&copy;
2022
&sdot;</p><a class=hover:underline href=https://twiddlingbits.net>twiddling bits</a>
<a class=text-gray-500 type=application/rss+xml href=https://twiddlingbits.net/posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentcolor"><path d="M5 3a1 1 0 000 2c5.523.0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z"/><path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0 5 5 0 00-5-5A1 1 0 014 9zM3 15a2 2 0 114 0 2 2 0 01-4 0z"/></svg></a></div><a class="flex justify-center gap-x-1 text-gray-500 text-sm hover:underline" href=https://ko-fi.com/twiddlingbits><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5.0 000 6.364L12 20.364l7.682-7.682a4.5 4.5.0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5.0 00-6.364.0z"/></svg>support</a></footer></div></body></html>